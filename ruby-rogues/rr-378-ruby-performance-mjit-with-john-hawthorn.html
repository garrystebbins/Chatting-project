---
layout: layouts/post.njk
title: >
      RR 378: Ruby performance: MJIT with John Hawthorn
date: 2018-09-04 10:00:16
episode_number: 378
duration: 44:17
audio_url: https://media.devchat.tv/ruby-rogues/RR_378_Ruby_performance_MJIT_with_John_Hawthorn.mp3
tags: ruby-rogues
---

<p class="p1"><span class="s1"><b>Panel: </b></span></p>

<ul>
 	<li class="p1"><span class="s1">Charles Max Wood</span></li>
 	<li class="p1"><span class="s1">David Richards</span></li>
 	<li class="p1"><span class="s1">Dave Kimura</span></li>
 	<li class="p1"><span class="s1">Eric Berry</span></li>
</ul>
<p class="p1"><span class="s1"><b>Special Guests:</b> John Hawthorn</span></p>
<p class="p1"><span class="s1">In this episode of Ruby Rogues, the panel talks to John Hawthorn about MJIT. John has been a <a href="https://www.ruby-lang.org/en/"><span class="s2">Ruby</span></a> programmer for about 9 years and is based in Victoria, B.C. They talk about what MJIT is, the effects you can see from using the MJIT compiler, and why the JIT doesn’t always work with other languages. They also touch on how you can use the JIT in your own code, how he makes his performance better, and more!</span></p>
<p class="p1"><span class="s1"><b>Show Topics:</b></span></p>
<p class="p1"><span class="s1">1:36 – John is a Ruby programmer, and has been one for the past 9 years, and he is based out of Victoria, B.C.</span></p>
<p class="p1"><span class="s1">5:00 – He had always been curious how a JIT would work and found that it was always too difficult to work with. Since discovering <a href="https://github.com/k0kubun/yarv-mjit"><span class="s2">MJIT</span></a>, he has been able to work with these compilers because he understands how to work with C code.</span></p>
<p class="p1"><span class="s1">7:36 – <a href="https://www.ruby-lang.org/en/"><span class="s2">Ruby</span></a> has a bytecode and it looks a lot like an assembly language, which is approachable to a Rubyist. </span></p>
<p class="p1"><span class="s1">8:24 – The core of MJIT is an ERB template which take this bytecode, loops over it, and emits C code. </span></p>
<p class="p1"><span class="s1">9:01 – Effects that you can seem from the JIT in your own code is that it uses a really tight math loop, making your code faster. </span></p>
<p class="p1"><span class="s1">11:25 – Other languages aren’t suited for compilers like JIT because they are so flexible to begin with. And in some cases, it doesn’t make sense to JIT compile. </span></p>
<p class="p1"><span class="s1">13:05 – The compiled code now is not reusable by other workers and works better with one compilation per process. </span></p>
<p class="p1"><span class="s1">15:20 – The temp folder gets cleared immediately after its run, but this compiled code is probably going to stay in memory forever. </span></p>
<p class="p3"><span class="s3">17:30 – The MJIT doesn’t work as well with <a href="https://rubyonrails.org/"><span class="s2">Rails</span></a></span><span class="s1"> because the code can’t get warmed up enough. Some things aren’t friendly to a JIT. </span></p>
<p class="p1"><span class="s1">20:24 – If someone wants to play with the JIT, as long as you have any Ruby version manager, install any of the previewed releases of 2.6 and then run with --jit. </span></p>
<p class="p1"><span class="s1">21:44 – Online, you can look into following people who have written various Ruby libraries to look at performance. You can look at people like <a href="https://samsaffron.com/"><span class="s2">Sam Saffron</span></a> and <a href="https://jvns.ca/"><span class="s2">Julia Evans</span></a>.</span></p>
<p class="p1"><span class="s1">23:57 –<a href="https://github.com/oracle/truffleruby"><span class="s2">TruffleRuby</span></a> is a new front-end on top of a mature virtual machine whereas MJIT is a brand new virtual machine on top of a Ruby front-end. </span></p>
<p class="p1"><span class="s1">27:57 – The MJIT had no effect on his work, it was just really fun and interesting to look into.</span></p>
<p class="p1"><span class="s1">28:29 – To make his performance better, he allocates fewer objects, does less loops, and writes better queries. </span></p>
<p class="p1"><span class="s1">29:02 – You want to run a profiler that will give you a better idea of where to look for performance issues, but you really need a proper benchmark to say what is wrong with your performance. A great benchmark you can use is <a href="https://github.com/evanphx/benchmark-ips"><span class="s2">benchmark-ips</span></a>. </span></p>
<p class="p1"><span class="s1">31:59 – The “gotcha” of doing this kind of work is verifying that you’ve actually improved it. </span></p>
<p class="p1"><span class="s1">33:41 – Before we have the JIT in production, we are going to be using these techniques to find out if the JIT is helping us.</span></p>
<p class="p6"><span class="s1"><b>Links:</b></span></p>

<ul class="ul1">
 	<li class="li7"><span class="s4"><a href="https://devchat.tv/get-a-coder-job/"><span class="s2">Get a Coder Job Course</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://www.ruby-lang.org/en/"><span class="s2">Ruby</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://github.com/k0kubun/yarv-mjit"><span class="s2">MJIT</span></a></span></li>
 	<li class="li7"><span class="s5"><a href="https://www.johnhawthorn.com/2018/02/playing-with-ruby-jit-mjit/"><span class="s6"><i>Playing with ruby's new JIT: MJIT</i> by John Hawthorn</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://rubyonrails.org/"><span class="s2">Rails</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://github.com/Shopify/bootsnap"><span class="s2">Bootsnap</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://samsaffron.com/"><span class="s2">Sam Saffron</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://jvns.ca/"><span class="s2">Julia Evans</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://github.com/oracle/truffleruby"><span class="s2">TruffleRuby</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://github.com/evanphx/benchmark-ips"><span class="s2">benchmark-ips</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://twitter.com/jhawthorn?lang=en"><span class="s2">@jhawthorn</span></a></span></li>
 	<li class="li7"><span class="s5"><a href="https://www.johnhawthorn.com/"><span class="s6">johnhawthorn.com</span></a></span></li>
 	<li class="li7"><span class="s5"><a href="https://github.com/jhawthorn"><span class="s6">John’s GitHub</span></a></span></li>
 	<li class="li8"></li>
</ul>
<p class="p6"><span class="s1"><b>Sponsors</b></span></p>

<ul class="ul1">
 	<li class="li7"><span class="s4"><a href="https://sentry.io/welcome/"><span class="s2">Sentry</span></a></span></li>
 	<li class="li7"><span class="s5"><a href="https://www.digitalocean.com/"><span class="s6">Digital Ocean</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://devchat.tv/get-a-coder-job/"><span class="s2">Get a Coder Job Course</span></a></span></li>
</ul>
<p class="p6"><span class="s1"><b>Picks:</b></span></p>
<p class="p3"><span class="s1">Charles</span></p>

<ul class="ul1">
 	<li class="li7"><span class="s4"><a href="https://www.amazon.com/s/ref=as_li_ss_tl?field-keywords=iron%2520druid%2520chronicles&amp;ascsub&amp;ref=aa_scomp_aapi1&amp;linkCode=sl2&amp;tag=devchattv-20&amp;linkId=e49d3e20a9fc3e71c28ac28516e5bd42&amp;language=en_US"><span class="s2"><i>Iron Druid Chronicles</i> by Kevin Hearne</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://zoom.us/"><span class="s2">Zoom</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://www.notion.so/"><span class="s2">Notion</span></a></span></li>
 	<li class="li3"><span class="s1">Eric Begay</span></li>
</ul>
<p class="p3"><span class="s1">Dave</span></p>

<ul class="ul1">
 	<li class="li7"><span class="s4"><a href="https://www.sony.com/electronics/headband-headphones/wh-1000xm2"><span class="s2">Sony WH-1000XM2</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://www.homedepot.com/p/Ryobi-120-Volt-Bench-Sander-BD4601G/205509608"><span class="s2">Ryobi Bench Sander</span></a></span></li>
</ul>
<p class="p3"><span class="s1">David</span></p>

<ul class="ul1">
 	<li class="li7"><span class="s4"><a href="https://www.imdb.com/title/tt1307789/"><span class="s2">Stephen Fry in America</span></a></span></li>
</ul>
<p class="p3"><span class="s1">Eric</span></p>

<ul class="ul1">
 	<li class="li7"><span class="s4"><a href="https://slides.limhenry.xyz/"><span class="s2">Remote for Slides</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="https://zoom.us/"><span class="s2">Zoom</span></a></span></li>
</ul>
<p class="p3"><span class="s1">John</span></p>

<ul class="ul1">
 	<li class="li7"><span class="s5"><a href="https://jvns.ca/categories/ruby-profiler/"><span class="s6">Julia Evans Blog Posts</span></a></span></li>
 	<li class="li7"><span class="s4"><a href="http://www.celestegame.com/"><span class="s2">Celeste</span></a></span></li>
</ul>

<h3>Transcript</h3>


